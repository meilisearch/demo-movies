name: Tests

on:
  pull_request:
  push:
    # trying and staging branches are for BORS config
    branches:
      - trying
      - staging
      - main

jobs:
  linter_check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup node
        uses: actions/setup-node@v4
        with:
          node-version: 18.19
      - name: Install dependencies
        run: yarn --dev
      - name: Run style check
        run: yarn lint
  cypress-run:
    runs-on: ubuntu-latest
    container:
      image: cypress/included:12.17.4
      options: --user 1001
    services:
      meilisearch:
        image: getmeili/meilisearch:v1.13.0
        env:
          MEILI_MASTER_KEY: "masterKey"
          MEILI_NO_ANALYTICS: "true"
        ports:
          - "7700:7700"
    steps:
      - uses: actions/checkout@v3
      - name: Setup node and cache
        uses: actions/setup-node@v4
        with:
          node-version: 18.19
          cache: "yarn"
          cache-dependency-path: yarn.lock
      - name: Install dependencies
        run: yarn
      - name: Install Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.1.3
      - name: Setup Meilisearch
        run: |
          yarn setup:settings
          yarn setup
        env:
          MEILISEARCH_HOST: http://meilisearch:7700
          MEILISEARCH_API_KEY: masterKey
          MEILISEARCH_ADMIN_API_KEY: masterKey
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          NEXT_PUBLIC_MEILISEARCH_HOST: http://meilisearch:7700
          NEXT_PUBLIC_MEILISEARCH_API_KEY: masterKey
      - name: Wait for Meilisearch to be ready
        run: |
          until curl -s http://meilisearch:7700/health | grep -q '"status":"available"'; do
            echo "Waiting for Meilisearch..."
            sleep 2
          done
      - name: Browser tests
        uses: cypress-io/github-action@v4
        with:
          start: yarn ci:dev
          wait-on: "http://localhost:3000"
          command: yarn cy:run
          config-file: cypress.config.js
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-screenshots
          path: cypress/screenshots
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-videos
          path: cypress/videos
